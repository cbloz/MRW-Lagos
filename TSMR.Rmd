---
title: "twosampleMR"
author: "OPS"
date: "12/03/2023"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r setwd}
setwd("~/Desktop/Papers/BMI/AFR/AFR3")
```

### Load in Exposure Data
```r
Exp <- read.delim("~/Desktop/Papers/BMI/AFR/AFR3/bmi_meta_new")
```
### Add header
```r
colnames(Exp) <- c("snp","MarkerName","Allele1","Allele2","Effect","StdErr","P-value","Direction")
```
### View the Exposure data
```r
head(Exp)
```
### Format the Exposure data to comply with TSMR package
```r
Exp_format <- format_data(Exp, header = TRUE, type = "exposure", snp_col = "snp", beta_col = "Effect", se_col = "StdErr", effect_allele_col = "Allele1", other_allele_col = "Allele2", eaf_col = "eaf", pval_col = "Pvalue")
```
### Load the Outcome Data
```r
Out <- read.delim("~/Desktop/Papers/BMI/AFR/AFR3/bmi_dbp_new", header=FALSE)
```
### Add header name to the outcome data
```r
colnames(Out) <- c("rs_number","reference_allele","other_allele","eaf","beta","se","beta_95L","beta_95U","z","p-value","-log10_p-value","q_statistic","q_p-value","i2","n_studies","n_samples","effects")
```
### View the Outcome data
```r
head(Out)
```

### Format the Outcome data to comply with TSMR package
```r
Out_format <- format_data(Out, header = TRUE, type = "outcome", snp_col = "rs_number", beta_col = "beta", se_col = "se", effect_allele_col = "reference_allele", other_allele_col = "other_allele", eaf_col = "eaf", pval_col = "p-value")
```

### Harmonize both exposure and outcome
*Note: there are different harmonization fuction depending on what we want to do with palindromic SNPs. This shall be explained in details.*
```r
Exp_Out_Harmonized <- harmonise_data(exposure_dat = Exp_format, outcome_dat = Out_format, action = 3)
```

### Clump both data
*Also take note of the different clumping threshold. Vary the clumping threshold and see how that impacts the results.*
```r
Exp_Out_Harmonized_Clumped <- clump_data(Exp_Out_Harmonized,clump_kb = 10000,clump_r2 = 0.1,clump_p1 = 1,clump_p2 = 1,pop = "AFR")
```
### Perform MR analysis
```r
res <- mr(Exp_Out_Harmonized_Clumped)
res
res$up_ci <- as.numeric(res$b) + 1.96 * as.numeric(res$se)
Exp$lo_ci <- as.numeric(res$b) - 1.96 * as.numeric(res$se)
write.table(res, file = "~/Desktop/Papers/BMI/AFR/AFR3/BMI_DBP_AFR_Result.txt", row.names = FALSE, col.names = TRUE, quote = FALSE, sep = "\t")
```

